<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTå®‰å“ç»ˆç«¯æ¨¡æ‹Ÿå™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.connected {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– å®‰å“å±å¹•ç»ˆç«¯ MQTT æ¨¡æ‹Ÿå™¨</h1>
    
    <div class="container">
        <h2>è¿æ¥çŠ¶æ€</h2>
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        
        <h3>è¿æ¥é…ç½®</h3>
        <div class="grid">
            <div>
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="serverUrl" value="ws://localhost:9001">
                <small>æ³¨æ„: WebSocketç«¯å£ä¸MQTTç«¯å£ä¸åŒ</small>
            </div>
            <div>
                <label>å®¢æˆ·ç«¯ID:</label>
                <input type="text" id="clientId" value="">
            </div>
        </div>
        
        <button onclick="connect()">è¿æ¥</button>
        <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
    </div>

    <div class="container">
        <h2>è®¾å¤‡æ³¨å†Œ</h2>
        <div class="grid">
            <div>
                <label>è®¾å¤‡ID:</label>
                <input type="text" id="deviceId" value="android_001">
                
                <label>è®¾å¤‡åç§°:</label>
                <input type="text" id="deviceName" value="å®‰å“å±å¹•ç»ˆç«¯_001">
                
                <label>ä½ç½®åç§°:</label>
                <input type="text" id="locationName" value="å¤§å…æ˜¾ç¤ºå±">
                
                <label>ä½ç½®åœ°å€:</label>
                <input type="text" id="locationAddress" value="åŒ—äº¬å¸‚æœé˜³åŒºxxxå¤§å¦1å±‚">
            </div>
            <div>
                <label>åˆ†è¾¨ç‡:</label>
                <input type="text" id="resolution" value="1920x1080">
                
                <label>å°ºå¯¸:</label>
                <input type="text" id="size" value="55å¯¸">
                
                <label>æ–¹å‘:</label>
                <select id="orientation">
                    <option value="horizontal">æ¨ªå±</option>
                    <option value="vertical">ç«–å±</option>
                </select>
                
                <label>ç»çº¬åº¦:</label>
                <input type="text" id="latitude" value="39.9042" placeholder="çº¬åº¦">
                <input type="text" id="longitude" value="116.4074" placeholder="ç»åº¦">
            </div>
        </div>
        <button onclick="registerDevice()">æ³¨å†Œè®¾å¤‡</button>
    </div>

    <div class="grid">
        <div class="container">
            <h2>æ¶ˆæ¯å‘é€</h2>
            
            <h3>å¿ƒè·³</h3>
            <button onclick="sendHeartbeat()">å‘é€å¿ƒè·³</button>
            
            <h3>çŠ¶æ€æ›´æ–°</h3>
            <select id="statusSelect">
                <option value="online">åœ¨çº¿</option>
                <option value="offline">ç¦»çº¿</option>
                <option value="maintenance">ç»´æŠ¤ä¸­</option>
                <option value="error">é”™è¯¯</option>
            </select>
            <button onclick="sendStatus()">å‘é€çŠ¶æ€</button>
            
            <h3>è®¾å¤‡æ•°æ®</h3>
            <select id="dataType">
                <option value="sensor">ä¼ æ„Ÿå™¨æ•°æ®</option>
                <option value="screenshot">æˆªå›¾</option>
                <option value="logs">æ—¥å¿—</option>
            </select>
            <textarea id="dataPayload" rows="3" placeholder="è¾“å…¥JSONæ•°æ®"></textarea>
            <button onclick="sendDeviceData()">å‘é€æ•°æ®</button>
            
            <h3>å†…å®¹å“åº”</h3>
            <input type="text" id="contentId" placeholder="å†…å®¹ID">
            <select id="contentStatus">
                <option value="playing">æ’­æ”¾ä¸­</option>
                <option value="completed">å·²å®Œæˆ</option>
                <option value="error">é”™è¯¯</option>
            </select>
            <button onclick="sendContentResponse()">å‘é€å“åº”</button>
        </div>
        
        <div class="container">
            <h2>æ¶ˆæ¯æ—¥å¿—</h2>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        let client = null;
        let clientId = 'android_terminal_' + Math.random().toString(16).substr(2, 8);
        document.getElementById('clientId').value = clientId;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.textContent = 'å·²è¿æ¥åˆ°MQTTæœåŠ¡å™¨';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'æœªè¿æ¥';
                statusDiv.className = 'status disconnected';
            }
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            clientId = document.getElementById('clientId').value;
            
            log(`å°è¯•è¿æ¥åˆ° ${serverUrl}ï¼Œå®¢æˆ·ç«¯ID: ${clientId}`);
            
            // æ³¨æ„: MQTT.js åœ¨æµè§ˆå™¨ä¸­éœ€è¦ WebSocket æ”¯æŒ
            // æ‚¨éœ€è¦é…ç½® MQTT broker çš„ WebSocket ç«¯å£
            log('è­¦å‘Š: æµè§ˆå™¨MQTTéœ€è¦WebSocketæ”¯æŒï¼Œè¯·é…ç½®MQTT brokerçš„WebSocketç«¯å£');
            log('å»ºè®®ä½¿ç”¨ mosquitto_pub/sub å‘½ä»¤è¡Œå·¥å…·æˆ– MQTT.fx å®¢æˆ·ç«¯è¿›è¡ŒçœŸå®æµ‹è¯•');
            
            try {
                client = mqtt.connect(serverUrl, {
                    clientId: clientId,
                    clean: true,
                    connectTimeout: 4000,
                    reconnectPeriod: 1000,
                });

                client.on('connect', () => {
                    log('âœ… è¿æ¥æˆåŠŸ!');
                    updateStatus(true);
                    
                    // è®¢é˜…ç›¸å…³ä¸»é¢˜
                    const topics = [
                        `device/${clientId}/register`,
                        `device/${clientId}/commands`,
                        `device/${clientId}/content`,
                        `device/${clientId}/heartbeat`,
                        `broadcast/all`
                    ];
                    
                    topics.forEach(topic => {
                        client.subscribe(topic, (err) => {
                            if (!err) {
                                log(`ğŸ“¢ è®¢é˜…ä¸»é¢˜: ${topic}`);
                            }
                        });
                    });
                });

                client.on('message', (topic, message) => {
                    const messageStr = message.toString();
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ [${topic}]: ${messageStr}`);
                    
                    try {
                        const data = JSON.parse(messageStr);
                        if (data.type === 'register_response') {
                            log('âœ… è®¾å¤‡æ³¨å†ŒæˆåŠŸ!');
                        } else if (data.type === 'content_push') {
                            log('ğŸ“º æ”¶åˆ°å†…å®¹æ¨é€');
                        } else if (data.type === 'command') {
                            log(`ğŸ® æ”¶åˆ°å‘½ä»¤: ${data.data.command}`);
                        }
                    } catch (e) {
                        // æ¶ˆæ¯ä¸æ˜¯JSONæ ¼å¼
                    }
                });

                client.on('error', (error) => {
                    log(`âŒ è¿æ¥é”™è¯¯: ${error}`);
                    updateStatus(false);
                });

                client.on('offline', () => {
                    log('ğŸ“´ è¿æ¥æ–­å¼€');
                    updateStatus(false);
                });

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error}`);
            }
        }

        function disconnect() {
            if (client) {
                client.end();
                client = null;
                updateStatus(false);
                log('ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥');
            }
        }

        function sendMessage(topic, message) {
            if (!client || !client.connected) {
                log('âŒ æœªè¿æ¥åˆ°MQTTæœåŠ¡å™¨');
                return;
            }
            
            const messageStr = JSON.stringify(message);
            client.publish(topic, messageStr, (err) => {
                if (err) {
                    log(`âŒ å‘é€å¤±è´¥: ${err}`);
                } else {
                    log(`ğŸ“¤ å‘é€æ¶ˆæ¯åˆ° ${topic}: ${messageStr}`);
                }
            });
        }

        function registerDevice() {
            const message = {
                type: 'register',
                deviceId: document.getElementById('deviceId').value,
                clientId: clientId,
                timestamp: Date.now(),
                data: {
                    deviceId: document.getElementById('deviceId').value,
                    name: document.getElementById('deviceName').value,
                    type: 'android_screen',
                    location: {
                        name: document.getElementById('locationName').value,
                        address: document.getElementById('locationAddress').value,
                        coordinates: {
                            latitude: parseFloat(document.getElementById('latitude').value),
                            longitude: parseFloat(document.getElementById('longitude').value)
                        }
                    },
                    specifications: {
                        resolution: document.getElementById('resolution').value,
                        size: document.getElementById('size').value,
                        orientation: document.getElementById('orientation').value
                    },
                    version: '1.0.0',
                    capabilities: ['display', 'audio', 'touch']
                }
            };
            
            sendMessage('device/register', message);
        }

        function sendHeartbeat() {
            const message = {
                type: 'heartbeat',
                deviceId: document.getElementById('deviceId').value,
                clientId: clientId,
                timestamp: Date.now(),
                data: {
                    uptime: Date.now(),
                    memoryUsage: Math.random() * 100,
                    cpuUsage: Math.random() * 100
                }
            };
            
            sendMessage('device/heartbeat', message);
        }

        function sendStatus() {
            const message = {
                type: 'status',
                deviceId: document.getElementById('deviceId').value,
                clientId: clientId,
                timestamp: Date.now(),
                data: {
                    status: document.getElementById('statusSelect').value,
                    deviceInfo: {
                        battery: Math.floor(Math.random() * 100),
                        temperature: Math.floor(Math.random() * 40) + 20,
                        brightness: Math.floor(Math.random() * 100)
                    }
                }
            };
            
            sendMessage('device/status', message);
        }

        function sendDeviceData() {
            let payload;
            try {
                payload = JSON.parse(document.getElementById('dataPayload').value || '{}');
            } catch (e) {
                payload = { raw: document.getElementById('dataPayload').value };
            }
            
            const message = {
                type: 'data',
                deviceId: document.getElementById('deviceId').value,
                clientId: clientId,
                timestamp: Date.now(),
                data: {
                    dataType: document.getElementById('dataType').value,
                    payload: payload
                }
            };
            
            sendMessage('device/data', message);
        }

        function sendContentResponse() {
            const message = {
                type: 'content_response',
                deviceId: document.getElementById('deviceId').value,
                clientId: clientId,
                timestamp: Date.now(),
                data: {
                    contentId: document.getElementById('contentId').value,
                    status: document.getElementById('contentStatus').value,
                    timestamp: Date.now()
                }
            };
            
            sendMessage('device/content_response', message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.onload = function() {
            log('ğŸš€ MQTTå®‰å“ç»ˆç«¯æ¨¡æ‹Ÿå™¨å·²åŠ è½½');
            log('âš ï¸  æ³¨æ„: æµè§ˆå™¨éœ€è¦WebSocketæ”¯æŒæ‰èƒ½è¿æ¥MQTT');
            log('ğŸ’¡ å»ºè®®ä½¿ç”¨mosquitto_pub/subæˆ–MQTT.fxè¿›è¡ŒçœŸå®æµ‹è¯•');
            log('');
            log('ğŸ“‹ æµ‹è¯•å‘½ä»¤ç¤ºä¾‹ (mosquittoå®¢æˆ·ç«¯):');
            log('# æ³¨å†Œè®¾å¤‡:');
            log('mosquitto_pub -h localhost -p 1884 -t "device/register" -m \'{"type":"register","deviceId":"android_001","clientId":"test_client","timestamp":' + Date.now() + ',"data":{"deviceId":"android_001","name":"æµ‹è¯•ç»ˆç«¯","type":"android_screen","location":{"name":"æµ‹è¯•ä½ç½®","address":"æµ‹è¯•åœ°å€","coordinates":{"latitude":39.9042,"longitude":116.4074}},"specifications":{"resolution":"1920x1080","size":"55å¯¸","orientation":"horizontal"}}}\'');
            log('');
            log('# å‘é€å¿ƒè·³:');
            log('mosquitto_pub -h localhost -p 1884 -t "device/heartbeat" -m \'{"type":"heartbeat","deviceId":"android_001","clientId":"test_client","timestamp":' + Date.now() + ',"data":{"uptime":12345}}\'');
        };
    </script>
</body>
</html>
